pipeline {

    agent any

    stages {

        stage('Preparations') {
            steps {
                script{ 
                    echo 'Preparation Stage: Started'
                    
                    sh """
                         if [ ! -f helm ]; then
                            /usr/bin/curl -fsSL -o helm.tar.gz  https://get.helm.sh/helm-v3.7.1-linux-amd64.tar.gz
                            tar -xzf helm.tar.gz linux-amd64/helm
                            mv linux-amd64/helm helm
                            chmod +x helm
                        fi
                    """

                    sh """
                        if [ ! -f kubectl ]; then
                            /usr/bin/curl -LO "https://dl.k8s.io/release/`curl -L -s https://dl.k8s.io/release/stable.txt`/bin/linux/amd64/kubectl"
                            chmod +x kubectl
                        fi
                    """
                    echo 'Preparation Stage: Finished'
                }
            }          
        }

        stage('Helm-Installation') {
            steps {
                echo 'Helm-Installation Stage: Started'

                sh "${WORKSPACE}/kubectl get pods"
                sh "${WORKSPACE}/helm repo add azure-samples https://azure-samples.github.io/helm-charts/"
                sh "${WORKSPACE}/helm install hello-world azure-samples/aks-helloworld --set serviceType=LoadBalancer -n jenkins"
                sh "${WORKSPACE}/kubectl autoscale deployment acs-helloworld-hello-world --cpu-percent=50 --min=1 --max=10 -n jenkins"
                
                echo 'Helm-Installation Stage: Finished'
            }          
        }
    }       
}                   